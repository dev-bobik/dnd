<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DnD Battle Grid</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      margin: 0;
      padding: 0;
      background-color: #2e2e2e;
      color: white;
      height: 100vh;
    }

    #sidebar {
      width: 200px;
      background-color: #1f1f1f;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }

    .library-token {
      width: 100%;
      height: auto;
      cursor: grab;
      border: 1px solid #666;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    #controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    #grid-container {
      position: relative;
      width: 1000px;
      aspect-ratio: 1 / 1;
    }

    #background {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #grid {
      display: grid;
      gap: 1px;
      background-color: transparent;
      border: 2px solid #555;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      width: 100%;
      height: 100%;
    }

    .cell {
      background-color: rgba(68, 68, 68, 0.7);
      border: 1px solid #666;
      position: relative;
    }

    .token {
      position: absolute;
      cursor: grab;
      z-index: 2;
      object-fit: contain;
    }

    input[type="file"], select {
      margin: 0.5rem 0;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCIZjiTltMTVktH4qTuW4iclUqFwuIbU9E",
      authDomain: "heil-47dc3.firebaseapp.com",
      databaseURL: "https://heil-47dc3-default-rtdb.firebaseio.com",
      projectId: "heil-47dc3",
      storageBucket: "heil-47dc3.appspot.com",
      messagingSenderId: "204548727050",
      appId: "1:204548727050:web:14066e11908a1fd97f9af3",
      measurementId: "G-TJZZDNCV05"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.auth().signInAnonymously().catch(console.error);
    const db = firebase.database();
  </script>
</head>
<body>
  <div id="sidebar">
    <h3>Knihovna</h3>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/31/Red_circle.png/600px-Red_circle.png" class="library-token" draggable="true">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/88/Blue_circle.png/600px-Blue_circle.png" class="library-token" draggable="true">
  </div>
  <div id="main">
    <div id="controls">
      <input type="file" id="bgUpload" accept="image/*">
      <select id="gridOptions">
        <option value="10,100">10x10 (100px)</option>
        <option value="20,50">20x20 (50px)</option>
        <option value="50,20">50x50 (20px)</option>
        <option value="5,200">5x5 (200px)</option>
      </select>
      <button id="generateGrid">Vytvořit mřížku</button>
    </div>
    <div id="grid-container">
      <img id="background">
      <div id="grid"></div>
    </div>
  </div>
  <script>
    const bgUpload = document.getElementById('bgUpload');
    const background = document.getElementById('background');
    const grid = document.getElementById('grid');
    const gridOptions = document.getElementById('gridOptions');
    const generateGridBtn = document.getElementById('generateGrid');

    let draggedToken = null;

    bgUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        background.src = e.target.result;
        db.ref('background').set(e.target.result);
      };
      reader.readAsDataURL(file);
    });

    db.ref('background').on('value', snapshot => {
      const src = snapshot.val();
      if (src) background.src = src;
    });

    function generateGrid(rows, size) {
      grid.innerHTML = '';
      grid.style.gridTemplateColumns = `repeat(${rows}, 1fr)`;
      grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
      for (let i = 0; i < rows * rows; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        grid.appendChild(cell);
      }
    }

    generateGridBtn.addEventListener('click', () => {
      const [rows, size] = gridOptions.value.split(',').map(Number);
      generateGrid(rows, size);
      db.ref('gridSize').set({ rows, size });
    });

    db.ref('gridSize').on('value', snapshot => {
      const val = snapshot.val();
      if (!val) return;
      const { rows, size } = val;
      if (rows && size) generateGrid(rows, size);
    });

    document.querySelectorAll('.library-token').forEach(token => {
      token.addEventListener('dragstart', e => {
        draggedToken = token.cloneNode(true);
        draggedToken.classList.add('token');
        draggedToken.setAttribute('draggable', 'true');
      });
    });

    grid.addEventListener('dragover', e => e.preventDefault());

    grid.addEventListener('drop', e => {
      e.preventDefault();
      if (!draggedToken) return;

      const gridRect = grid.getBoundingClientRect();
      const x = e.clientX - gridRect.left;
      const y = e.clientY - gridRect.top;

      const rows = parseInt(grid.style.gridTemplateRows.split(' ').length);
      const cols = parseInt(grid.style.gridTemplateColumns.split(' ').length);
      const cellWidth = grid.clientWidth / cols;
      const cellHeight = grid.clientHeight / rows;

      const col = Math.floor(x / cellWidth);
      const row = Math.floor(y / cellHeight);

      const left = col * cellWidth;
      const top = row * cellHeight;

      draggedToken.style.left = `${left}px`;
      draggedToken.style.top = `${top}px`;
      draggedToken.style.width = `${cellWidth}px`;
      draggedToken.style.height = `${cellHeight}px`;

      grid.appendChild(draggedToken);
      draggedToken = null;
    });
  </script>
</body>
</html>
